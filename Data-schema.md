# Data Schema & Storage Design

This document outlines the data structure for SyncTask. It visualizes the entities, their relationships, and most importantly, where this data lives (Physical Boundaries) as we move from MVP to Phase I.

---

## 1. Simplified Schema Diagram with Boundaries

This diagram separates data by its physical storage location.

Arrows denote relationships (`||--o{` is 1-to-N).

Subgraphs denote the specific database/storage engine.

```mermaid
graph TD
    %% STYLES
    classDef sql fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
    classDef redis fill:#ffebee,stroke:#c62828,stroke-width:2px;
    classDef s3 fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
    
    %% --- BOUNDARY 1: POSTGRESQL (Core Relational Data) ---
    subgraph PostgreSQL ["üêò SQL Database (Persistent Relational Data)"]
        direction TB
        
        User[("**USER**<br/>id: UUID<br/>email: Varchar<br/>password_hash: Varchar<br/>created_at: Timestamp")]:::sql
        
        Board[("**BOARD**<br/>id: UUID<br/>owner_id: UUID (FK)<br/>title: Varchar<br/>is_private: Boolean")]:::sql
        
        BoardMember[("**BOARD_MEMBER (Join Table)**<br/>board_id: UUID (FK)<br/>user_id: UUID (FK)<br/>role: Enum (Admin/Editor)")]:::sql
        
        Task[("**TASK**<br/>id: UUID<br/>board_id: UUID (FK)<br/>assignee_id: UUID (FK)<br/>status: Varchar (Todo/Done)<br/>position: Float (Lexorank)")]:::sql
        
        FileMeta[("**FILE_METADATA**<br/>id: UUID<br/>task_id: UUID (FK)<br/>s3_key: Varchar<br/>mime_type: Varchar")]:::sql
    end

    %% --- BOUNDARY 2: REDIS (Ephemeral) ---
    subgraph Redis ["üî• Redis (Cache & Real-time Session)"]
        Session[("**SESSION STORE**<br/>Key: user_id<br/>Value: { socket_id, active_board }<br/>TTL: 24h")]:::redis
        
        PubSub[("**PUBSUB CHANNELS**<br/>Channel: board_{id}<br/>Payload: { event_type, data }")]:::redis
    end

    %% --- BOUNDARY 3: S3 (Blob Storage) ---
    subgraph S3 ["üì¶ S3 Object Storage (Phase I)"]
        FileBlob[("**BINARY BLOB**<br/>Key: {uuid}.png<br/>Content: Bytes")]:::s3
    end

    %% --- RELATIONSHIPS ---
    
    %% User to Board (1:N Ownership)
    User -- "Owns (1:n)" --> Board
    
    %% User to BoardMember (1:n) & Board to BoardMember (1:n) -> N:N
    User -- "Member of" --> BoardMember
    Board -- "Has members" --> BoardMember
    
    %% Board to Task (1:N)
    Board -- "Contains (1:n)" --> Task
    
    %% User to Task (Assignment)
    User -- "Assigned to (1:n)" --> Task
    
    %% Task to File Metadata (1:N)
    Task -- "Has attachments (1:n)" --> FileMeta
    
    %% File Meta to S3 (Logical Link)
    FileMeta -.->|Reference by Key| FileBlob
    
    %% User to Session (1:1 Active)
    User -.->|Authenticates| Session
```

---

## 2. Entity Details & Implementation Notes

### A. The SQL Boundary (PostgreSQL)

Primary storage for all structured business data.

#### Users
- **Core Property:** `password_hash`. Never store plain text passwords.
- **Phase I Note:** We index `email` for fast login lookups (Flow 1).

#### Boards & BoardMembers
- **Relationship:** n-n (Many-to-Many).
- **Implementation:** We use a "Join Table" (`BoardMember`) rather than an array of IDs.
- **Why?** This allows us to store extra data like `role` (Admin vs Viewer) per user, per board.

#### Tasks
- **Core Property:** `position` (Float).
- **Why Float?** For Drag-and-Drop (Flow 3). If Task A is 1.0 and Task B is 2.0, putting Task C between them makes it 1.5. This avoids rewriting every single row in the DB when an item moves.

#### File_Metadata (Phase I)
- **Important:** The database does not store the image itself. It only stores the `s3_key` (the address) and the `mime_type`. This keeps the database lightweight and fast.

### B. The Redis Boundary (In-Memory)

Ephemeral storage for performance and real-time syncing.

#### Session Store
- **Data:** Maps a `user_id` to their current active WebSocket `socket_id`.
- **Usage:** When User A moves a card, the API looks up User B's `socket_id` here to send the push notification specifically to them (or broadcasts to the channel).

#### PubSub Channels
- **Concept:** Transient message buses. Data is not "stored" here long-term, but passes through.

### C. The S3 Boundary (Object Storage)

Heavy storage for binary files.

#### Binary Blob
- **Data:** The actual bytes of images/PDFs attached to tasks.
- **Access:** Accessed via a Signed URL generated by the API, keeping the bucket private.

---

## 3. Key Relationship Types

| Relationship | Entities | Description |
|--------------|----------|-------------|
| 1-to-N | Board -> Task | One board has many tasks. A task belongs to only one board. |
| N-to-N | User <-> Board | A user can join many boards; a board has many users. Managed via `BoardMember` table. |
| 1-to-1 | User -> Session | A user typically has one active WebSocket connection per device. |
| Reference | FileMeta -> S3 Blob | Logical link. The DB row "points" to the file in the cloud. |
